
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event counting &#8212; Stimfit 0.16.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Object oriented programming with Stimfit" href="introclass.html" />
    <link rel="prev" title="Cutting traces" href="cuttingtraces.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="introclass.html" title="Object oriented programming with Stimfit"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cuttingtraces.html" title="Cutting traces"
             accesskey="P">previous</a> |</li>
    <li><a href="http://github.com/neurodroid/stimfit/wiki/Stimfit">Stimfit Homepage</a> | &nbsp; </li>
    <li><a href="http://github.com/neurodroid/stimfit" }}>Developer (Github)</a> | &nbsp; </li>
    <li><a href=../index.html>Documentation Home</a> | &nbsp; </li>

    

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">The Stimfit book of spells</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Event counting</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="event-counting">
<h1>Event counting<a class="headerlink" href="#event-counting" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors</dt>
<dd class="field-odd"><p>Jose Guzman</p>
</dd>
<dt class="field-even">Updated</dt>
<dd class="field-even"><p>19 August, 2021</p>
</dd>
</dl>
<p>Counting the number of events (for example action potentials) within a time window is a very common task in electrophysiology. In its simplest form, the user would like to know how many spikes occur following the onset of a stimulus (i.e current injection). We can write a simple Python function which automatically performs this calculation with a simple event detection routine.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="http://www.stimfit.org">Stimfit</a> has built-in functions to count the number of events (i.e action potentials). From the menu, select Analysis -&gt; event detection-&gt; threshold crossing… or alternatively with the Analysis-&gt; Batch analysis-&gt;threshold crossing. However, this Python script allows for more flexibility while counting events, such as detecting positive- or negative-going events.</p>
</div>
<div class="section" id="the-counter-event-function">
<h2>The counter event function<a class="headerlink" href="#the-counter-event-function" title="Permalink to this headline">¶</a></h2>
<p>The following function counts the number of events (e.g action potentials) by detecting upward (up=True) or downward (up=False) threshold-crossings.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load main Stimfit module</span>
<span class="kn">import</span> <span class="nn">stf</span>

<span class="k">def</span> <span class="nf">count_events</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of events (e.g action potentials (AP)) in the current trace.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    start       -- starting time (in ms) to look for events.</span>
<span class="sd">    delta       -- time interval (in ms) to look for events.</span>
<span class="sd">    threshold   -- (optional) detection threshold (default = 0).</span>
<span class="sd">    up          -- (optional) True (default) will look for upward events, False downwards.</span>
<span class="sd">    trace       -- (optional) zero-based index of the trace in the current channel,</span>
<span class="sd">                   if None, the current trace is selected.</span>
<span class="sd">    mark        -- (optional) if True (default), set a mark at the point of threshold crossing</span>
<span class="sd">    Returns:</span>
<span class="sd">    An integer with the number of events.</span>

<span class="sd">    Examples:</span>
<span class="sd">    count_events(500,1000) returns the number of events found between t=500 ms and t=1500 ms</span>
<span class="sd">        above 0 in the current trace and shows a stf marker.</span>
<span class="sd">    count_events(500,1000,0,False,-10,i) returns the number of events found below -10 in the</span>
<span class="sd">        trace i and shows the corresponding stf markers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># sets the current trace or the one given in trace.</span>
    <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sweep</span> <span class="o">=</span> <span class="n">stf</span><span class="o">.</span><span class="n">get_trace_index</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span> <span class="o">!=</span><span class="nb">int</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;trace argument admits only integers&quot;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">sweep</span> <span class="o">=</span> <span class="n">trace</span>

    <span class="c1"># set the trace described in sweep</span>
    <span class="n">stf</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">sweep</span><span class="p">)</span>

    <span class="c1"># transform time into sampling points</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">stf</span><span class="o">.</span><span class="n">get_sampling_interval</span><span class="p">()</span>

    <span class="n">pstart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span><span class="n">start</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">pdelta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span><span class="n">delta</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># select the section of interest within the trace</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">stf</span><span class="o">.</span><span class="n">get_trace</span><span class="p">()[</span><span class="n">pstart</span><span class="p">:(</span><span class="n">pstart</span><span class="o">+</span><span class="n">pdelta</span><span class="p">)]</span>

    <span class="c1"># algorithm to detect events</span>
    <span class="n">EventCounter</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="c1"># set counter and index to zero</span>

    <span class="c1"># choose comparator according to direction:</span>
    <span class="k">if</span> <span class="n">up</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span>

    <span class="c1"># run the loop</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">threshold</span><span class="p">):</span>
            <span class="n">EventCounter</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">mark</span><span class="p">:</span>
                <span class="n">stf</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="n">pstart</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">threshold</span><span class="p">):</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span> <span class="c1"># skip values if index in bounds AND until the value is below/above threshold again</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">EventCounter</span>
</pre></div>
</div>
</div>
<div class="section" id="code-commented">
<h2>Code commented<a class="headerlink" href="#code-commented" title="Permalink to this headline">¶</a></h2>
<p>The traces are selected by the optional argument trace, as explained in <a class="reference internal" href="amplitudes.html"><span class="doc">Calculations on selected traces</span></a>. The algorithm to detect action potentials requires some familiarity with Python iterations but it is easy to understand.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">comp</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="n">EventCounter</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span> <span class="c1"># skip if index in bounds AND values until the value is below or above threshold again</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</pre></div>
</div>
<p>The while loop allows us to move within the indices of the array called selection. We insert an if-block inside to test whether the threshold is crossed at [i]. In this case we will add 1 to the counter (EventCounter +=1) and move to the second while loop.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span> <span class="c1"># skip if index in bounds AND values until the value is below or above threshold again</span>
</pre></div>
</div>
<p>This second loop is very important. The index moves within the array until the value crosses the threshold again in the other direction. We have to skip every value until the threshold is crossed again. If we do do this while here, the if condition will be True for all values after the threshold crossing, and the counter would give us the number of sampling points between threshold crossings (and not the number of events). Finally, it is important to do this loop whenever the index is inside the limits of the selection.</p>
<p>Finally, if the condition is not true, the else statement will move the index one possition next in the array. The main while loop (while i&lt;len(selection)) will evaluate for every point if the threshold is achieved. Note that preserving the Python indentation is extremely important here.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not try to write while loops in the embedded python console of <a class="reference external" href="http://www.stimfit.org">Stimfit</a> unless you are very familiar with while loops in Python or in any other language. While loops, if written incorrectly, may run infinite iterations and block the Python terminal of <a class="reference external" href="http://www.stimfit.org">Stimfit</a>. For that reason, it is a good idea to explore while loops in an independent python terminal before using them in <a class="reference external" href="http://www.stimfit.org">Stimfit</a>.</p>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>As in <a class="reference internal" href="amplitudes.html"><span class="doc">Calculations on selected traces</span></a> we can use the function in different ways:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">spells</span><span class="o">.</span><span class="n">count_events</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">delta</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>will return the number of events above 0 mV in the current trace/channel between t=500 ms and t=1500 ms, and shows a blue stf marker</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">spells</span><span class="o">.</span><span class="n">count_events</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">delta</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">threshold</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span><span class="n">up</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>this will look for events below the value -40 but not in the current trace, only in the trace 11 (zero-based index is 10) in the downwards direction. Here a blue marker around the point found bellow the threshold will be shown too. Note that functions with a large number of arguments are difficult to remember. You can always change the order of the arguments if you describe the arguments in the function. For example, the following sentence has the same effect as the one above, but shows a different argument order:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">spells</span><span class="o">.</span><span class="n">count_events</span><span class="p">(</span><span class="n">threshold</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">up</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">delta</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to create a list of events with the events found in a selection of traces, you can type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">spikes_list</span><span class="o">=</span> <span class="p">[</span><span class="n">spells</span><span class="o">.</span><span class="n">count_events</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stf</span><span class="o">.</span><span class="n">get_selected_indices</span><span class="p">()]</span>
</pre></div>
</div>
<p>this will create a Python list with the number of events (e.g spikes) found between t=500ms and t=1500ms above 0 in the selected traces and no marker will be shown. In the same way as described previously in , you can create a table to copy the results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mytable</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stf</span><span class="o">.</span><span class="n">get_selected_indices</span><span class="p">():</span> <span class="n">mytable</span><span class="p">[</span><span class="s2">&quot;Trace </span><span class="si">%.3d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spikes_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stf</span><span class="o">.</span><span class="n">show_table</span><span class="p">(</span><span class="n">mytable</span><span class="p">)</span>
</pre></div>
</div>
<p>this creates a table with 2 columns with the trace number a number of spikes found previously.</p>
<p>Obviously, the function could be extended to return the time points of threshold crossings so that the interspike intervals can be calculated. This is left as an exercise to the reader.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Use the <a class="reference internal" href="../stf_reference/stf.html#stf.erase_markers" title="stf.erase_markers"><code class="xref py py-func docutils literal notranslate"><span class="pre">stf.erase_markers()</span></code></a> to clean the blue markers on the main stf window. If not, every time that you call the routine in the given trace, a series of blue markers showing the crossing points of the different threshold will overlap with each other. Alternatively, you can add <a class="reference internal" href="../stf_reference/stf.html#stf.erase_markers" title="stf.erase_markers"><code class="xref py py-func docutils literal notranslate"><span class="pre">stf.erase_markers()</span></code></a> in the beginning of count_events() to delete any marker presented previously:</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/stimfit_128.png" alt="Logo"/>
            </a></p>
  <h3><a href="../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Event counting</a><ul>
<li><a class="reference internal" href="#the-counter-event-function">The counter event function</a></li>
<li><a class="reference internal" href="#code-commented">Code commented</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cuttingtraces.html"
                        title="previous chapter">Cutting traces</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="introclass.html"
                        title="next chapter">Object oriented programming with Stimfit</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/stimfit_128.png" alt="Logo"/>
            </a></p>
  <h3><a href="../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Event counting</a><ul>
<li><a class="reference internal" href="#the-counter-event-function">The counter event function</a></li>
<li><a class="reference internal" href="#code-commented">Code commented</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cuttingtraces.html"
                        title="previous chapter">Cutting traces</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="introclass.html"
                        title="next chapter">Object oriented programming with Stimfit</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Christoph Schmidt-Hieber.
      Last updated on 19 August, 2021.
    </div>
  </body>
</html>