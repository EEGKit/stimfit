
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Event extraction by template matching &#8212; Stimfit 0.16.0 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bibliography" href="bibliography.html" />
    <link rel="prev" title="Latency measurements" href="latency_measurements.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="bibliography.html" title="Bibliography"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="latency_measurements.html" title="Latency measurements"
             accesskey="P">previous</a> |</li>
    <li><a href="http://github.com/neurodroid/stimfit/wiki/Stimfit">Stimfit Homepage</a> | &nbsp; </li>
    <li><a href="http://github.com/neurodroid/stimfit" }}>Developer (Github)</a> | &nbsp; </li>
    <li><a href=../index.html>Documentation Home</a> | &nbsp; </li>

    

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Stimfit manual</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="event-extraction-by-template-matching">
<h1>Event extraction by template matching<a class="headerlink" href="#event-extraction-by-template-matching" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Christoph Schmidt-Hieber (christsc at gmx.de)</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">05 August, 2021</td>
</tr>
</tbody>
</table>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>To isolate individual events such as EPSCs or EPSPs from recorded data, <a class="reference external" href="http://www.stimfit.org">Stimfit</a> uses a template matching algorithm as described by Jonas et al. (1993) <a class="footnote-reference" href="#jonas1993" id="id1">[1]</a>, with some implementation details adopted from Clemens and Bekkers (1997) <a class="footnote-reference" href="#clemensbekkers1997" id="id2">[2]</a>. The template consists of a waveform <img class="math" src="../_images/math/9637b3dff12abf5752e6c828cd6236d58419496d.png" alt="p(t)"/> with a length of <img class="math" src="../_images/math/e11f2701c4a39c7fe543a6c4150b421d50f1c159.png" alt="n"/> sampling points that represents the time course of a typical event. The template is slid over the trace of recorded values <img class="math" src="../_images/math/4070430aad8471b7d1d3d67169afa87584999e9c.png" alt="r(t)"/>, and at each sampling point with index <img class="math" src="../_images/math/63751cb2e98ba393b0f22e45ca127c3cebb61487.png" alt="s"/>, it is multiplied by a scaling factor <img class="math" src="../_images/math/edba97b4c0d864d26e92ea7ea73767fa38eef3f7.png" alt="m"/> and an offset <img class="math" src="../_images/math/ae12a24f88803b5895632e4848d87d46483c492c.png" alt="c"/> is added or subtracted so that the sum of squared errors <img class="math" src="../_images/math/b03a5e670cb6c900b0079476a6d607f443ff2822.png" alt="\chi^2(t_s)"/> between the trace and the template is minimized:</p>
<div class="math">
<p><img src="../_images/math/40dc9f2ad4845de5bb724506d96ff708b7bd44d3.png" alt="{\displaystyle \chi^2(t_s)= \sum_{k=0}^{n-1}\left[r(t_{s+k})-\left(m{\cdot}p(t_k)+c\right)\right]^2}"/></p>
</div><p>As can be seen from this equation, this amounts to the fairly simple operation of fitting a straight line that relates <img class="math" src="../_images/math/9637b3dff12abf5752e6c828cd6236d58419496d.png" alt="p(t)"/> and <img class="math" src="../_images/math/4070430aad8471b7d1d3d67169afa87584999e9c.png" alt="r(t)"/> at every sampling point.</p>
<p>Finally, some detection criterion has to be applied to decide whether an event has occurred at a sampling point. Two options are available in <a class="reference external" href="http://www.stimfit.org">Stimfit</a>: Jonas et al. (1993) <a class="footnote-reference" href="#jonas1993" id="id4">[1]</a> suggest to use the linear correlation coefficient between the optimally scaled template and the data, whereas Clements and Bekkers (1997) <a class="footnote-reference" href="#clemensbekkers1997" id="id5">[2]</a> compare the scaling factor with the noise standard deviation.</p>
</div>
<div class="section" id="a-practical-guide-to-event-detection">
<h2>A practical guide to event detection<a class="headerlink" href="#a-practical-guide-to-event-detection" title="Permalink to this headline">¶</a></h2>
<p>In practice, the following steps need to be performed to extract events with <a class="reference external" href="http://www.stimfit.org">Stimfit</a>:</p>
<ol class="arabic simple">
<li>Create a preliminary template by fitting a function to a single, large and isolated event.</li>
<li>Use this preliminary template to extract some more exemplary large and isolated events using a high detection threshold.</li>
<li>Create a final template by fitting a function to the average of the exemplary events.</li>
<li>Extract all events with the final template using a low detection criterion threshold.</li>
<li>Eliminate false-positive, add false-negative events.</li>
</ol>
<p>This procedure will be explained in some more detail in the following sections.</p>
<div class="section" id="create-a-preliminary-template">
<h3>Create a preliminary template<a class="headerlink" href="#create-a-preliminary-template" title="Permalink to this headline">¶</a></h3>
<p>In general, the template waveform <img class="math" src="../_images/math/9637b3dff12abf5752e6c828cd6236d58419496d.png" alt="p(t)"/> can be of arbitrary shape. A typical way of creating such a template is to fit a function with a time course matching the event kinetics to some exemplary events. For example, EPSCs can typically be modeled with the sum or the product of two exponential functions <a class="footnote-reference" href="#f1" id="id7">[3]</a>. In practice, a robust estimate for a template can be obtained using an iterative approach, which will be illustrated here using a recording of miniature EPSCs that you can download <a class="reference external" href="http://stimfit.org/tutorial/minis.dat">here</a>.</p>
<blockquote>
<div><div class="figure align-center" id="id9">
<img alt="../_images/bait_template.png" src="../_images/bait_template.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 21:</strong> Creation of a “bait” template.</span></p>
</div>
</div></blockquote>
<p>First, we fit a function to a single large an isolated event to create a preliminary “bait” template. In this case, we will use the EPSC that can be found roughly between t = 20990 ms and t = 21050 ms. Then, we fit the sum of two exponential functions with a delay to this EPSC. To obtain the same template as in the example, you can call the function <code class="docutils literal notranslate"><span class="pre">preliminary</span></code> from the <code class="docutils literal notranslate"><span class="pre">minidemo</span></code> module that comes  bundled with <a class="reference external" href="http://www.stimfit.org">Stimfit</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">minidemo</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">minidemo</span><span class="o">.</span><span class="n">preliminary</span><span class="p">()</span>
</pre></div>
</div>
<p>This will take care of the appropriate cursor positions and the biexponential fit. If you prefer, you can use the fit settings dialog, as described in chapter 1 (Fig. 16).</p>
</div>
<div class="section" id="extract-exemplary-events">
<h3>Extract exemplary events<a class="headerlink" href="#extract-exemplary-events" title="Permalink to this headline">¶</a></h3>
<p>We now use the bait example to fish some more large and isolate events. Choose “Analysis”-&gt;”Event detection”-&gt;”Template matching…” from the menu.</p>
<blockquote>
<div><div class="figure align-center" id="id10">
<img alt="../_images/eventdetectionsettings.png" src="../_images/eventdetectionsettings.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 22:</strong> Event detection settings.</span></p>
</div>
</div></blockquote>
<p>In the dialog that will pop up (Fig. 22), you can set the threshold for the detection criterion. Since we want to extract some large and isolated events during this first pass, we set this to a high number, say 10, using the template scaling factor (Clemens and Bekkers, 1997). Click “OK” to start the event detection. When finished, press <strong>F</strong> to fit the whole trace to the window. The detected events will be marked by blue arrows in the upper part of the window, and blue circles will indicate the peak values of the detected events (Fig 23).</p>
<blockquote>
<div><div class="figure align-center" id="id11">
<img alt="../_images/events.png" src="../_images/events.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 23:</strong>  Detected events.</span></p>
</div>
</div></blockquote>
<p>To view the isolated events in a new window, you have to switch to the event editing mode, either by pressing <strong>E</strong> or by activating the corresponding button in the toolbar (Fig. 24). When you now click on the trace with the right mouse button, a menu will show up. Select “Extract selected events” from this menu. this will put the exemplary EPSCs into a new window.</p>
<blockquote>
<div><div class="figure align-center" id="id12">
<img alt="../_images/eventbutton.png" src="../_images/eventbutton.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 24:</strong> Switching to event editing mode.</span></p>
</div>
</div></blockquote>
</div>
<div class="section" id="create-the-final-template">
<h3>Create the final template<a class="headerlink" href="#create-the-final-template" title="Permalink to this headline">¶</a></h3>
<p>We now create the average of all extracted events, as explained in chapter 1. Then, we fit a biexponential function to the average, as explained above for the single EPSC. Remember to set the baseline, peak and fit window cursors appropriately before performing the fit, and to update all calculations. Again, you can make use of a function from the <code class="docutils literal notranslate"><span class="pre">minidemo</span></code> module to set the cursors and perform the fit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">minidemo</span> <span class="c1"># if you have not imported it already</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">minidemo</span><span class="o">.</span><span class="n">final</span><span class="p">()</span>
</pre></div>
</div>
<p>The final template should look similar as shown in Fig. 25</p>
<blockquote>
<div><div class="figure align-center" id="id13">
<img alt="../_images/finaltemplate.png" src="../_images/finaltemplate.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 25:</strong> Creating a final template.</span></p>
</div>
</div></blockquote>
</div>
<div class="section" id="extract-all-events">
<h3>Extract all events<a class="headerlink" href="#extract-all-events" title="Permalink to this headline">¶</a></h3>
<p>Go back to the original file (minis.dat). Extracting all events with the final template is done in nearly the same way as described above for the preliminary template. However, you have to choose the correct template in the event dialog: The final template in this case is the second on the list (Fig. 26). For this final run, we will lower the detection threshold to a value of 3, as suggested by Clements and Bekkers (1997).</p>
<blockquote>
<div><div class="figure align-center" id="id14">
<img alt="../_images/selectfinaltemplate.png" src="../_images/selectfinaltemplate.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 26:</strong> Selecting the final template.</span></p>
</div>
</div></blockquote>
</div>
<div class="section" id="edit-detected-events">
<h3>Edit detected events<a class="headerlink" href="#edit-detected-events" title="Permalink to this headline">¶</a></h3>
<p>Usually, the detected events have to be screened visually to remove false-positives and add false-negatives. Removing false-positives is done by unselected the checkbox next to the arrow indicating an event (Fig. 23). To add false-negatives, you have to switch to the event-editing mode (Fig. 24) and then right-click on the trace at the at the position where the event starts. from the context menu that will pop up, select “Add an event that starts here” (Fig. 27). To efficiently screen the whole trace, it is convenient to use <strong>Shift</strong>  and left arrow at the same time. this will move the trace left by the width of one window. Once you are done with editing, choose “Extract selected events” from the context menu.</p>
<blockquote>
<div><div class="figure align-center" id="id15">
<img alt="../_images/falsenegative.png" src="../_images/falsenegative.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 27:</strong> Adding a false-negative event.</span></p>
</div>
</div></blockquote>
</div>
<div class="section" id="analyze-extracted-events">
<h3>Analyze extracted events<a class="headerlink" href="#analyze-extracted-events" title="Permalink to this headline">¶</a></h3>
<p>If you used the same settings as suggested above, 97 events will be extracted. You will find a table on the left of the traces: This will show you the time of onset of the events and the inter-event intervals. Usually, you will want to apply some further analysis to the extracted events. To do so, you first have to adjust the baseline, peak and fit cursors. Again, there is a function in the <code class="docutils literal notranslate"><span class="pre">minidemo</span></code> module taking care of that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">minidemo</span><span class="o">.</span><span class="n">batch_cursors</span><span class="p">()</span>
</pre></div>
</div>
<p>To analyze all traces efficiently, you can now perform a “batch analysis” on all traces at once: First, select all traces, either using <a class="reference internal" href="../stf_reference/stf.html#stf.select_all" title="stf.select_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">stf.select_all()</span></code></a> from the shell, or “Edit”-&gt;”Select all traces” from the menu or pressing <strong>Ctrl + A</strong>. Then choose “Analysis”-&gt;”Batch analysis” from the menu.</p>
<blockquote>
<div><div class="figure align-center" id="id16">
<img alt="../_images/batchanalysis.png" src="../_images/batchanalysis.png" />
<p class="caption"><span class="caption-text"><strong>Fig. 28:</strong> Batch analysis settings.</span></p>
</div>
</div></blockquote>
<p>From the dialog (Fig 28) choose the analysis functions that you want to apply to your data. Click “OK” once your are done. A new table will appear to the left of the traces. You can copy and paste values from the tables to spreadsheet programs for further analysis.</p>
</div>
<div class="section" id="adjusting-event-detection-settings">
<h3>Adjusting event detection settings<a class="headerlink" href="#adjusting-event-detection-settings" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="57%" />
<col width="43%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>Problem</strong></td>
<td><strong>Solution</strong></td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple">
<li>Too many false-positive events have been detected.</li>
<li>Too many events have been missed (false-negatives)</li>
<li>One and the same event is detected multiple times at short time intervals</li>
<li>Closely spaced events are not detected separately</li>
</ol>
</td>
<td><ol class="first last arabic simple">
<li>Increase the detection threshold</li>
<li>Decrease the detection threshold</li>
<li>Increase the number of sampling points between events</li>
<li>Decrease the number of sampling points between events</li>
</ol>
</td>
</tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="jonas1993" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id4">2</a>)</em> Jonas P, Major G, Sakman B. (1993) Quantal components of unitary EPSCs at the mossy fibre synapse on CA3 pyramidal cells of rat hippocampus. J Physiol. 472, 615-663.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="clemensbekkers1997" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id5">2</a>)</em> Clements JD, Bekkers JM. (1997) Detection of spontaneous synaptic events with an optimally scaled template. Biophys J 73:220–229.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td>Note that the product of two exponentials <img class="math" src="../_images/math/940f31773942d693f6b03a528ebdbe34f8756765.png" alt="{\displaystyle f(t)=a(1-e^{-\frac{t}{\tau_1}})e^{-\frac{t}{\tau_2}}}"/> can equivalently be expressed as the sum of two exponentials: <img class="math" src="../_images/math/9a842cf0578afbd7754525502bab11d3feef2342.png" alt="{\displaystyle f(t)=a(e^{-\frac{t}{\tau_2}}-e^{-\frac{t}{\tau_3}}) }"/>, with <img class="math" src="../_images/math/f61ea0a67635a7d1646df303dedc0f7b63e6a325.png" alt="{\displaystyle \tau_3=\frac{\tau_2 \tau_1}{\tau_2-\tau_1}}"/>.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/stimfit_128.png" alt="Logo"/>
            </a></p>
  <h3><a href="../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Event extraction by template matching</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#a-practical-guide-to-event-detection">A practical guide to event detection</a><ul>
<li><a class="reference internal" href="#create-a-preliminary-template">Create a preliminary template</a></li>
<li><a class="reference internal" href="#extract-exemplary-events">Extract exemplary events</a></li>
<li><a class="reference internal" href="#create-the-final-template">Create the final template</a></li>
<li><a class="reference internal" href="#extract-all-events">Extract all events</a></li>
<li><a class="reference internal" href="#edit-detected-events">Edit detected events</a></li>
<li><a class="reference internal" href="#analyze-extracted-events">Analyze extracted events</a></li>
<li><a class="reference internal" href="#adjusting-event-detection-settings">Adjusting event detection settings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="latency_measurements.html"
                        title="previous chapter">Latency measurements</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="bibliography.html"
                        title="next chapter">Bibliography</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/stimfit_128.png" alt="Logo"/>
            </a></p>
  <h3><a href="../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Event extraction by template matching</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#a-practical-guide-to-event-detection">A practical guide to event detection</a><ul>
<li><a class="reference internal" href="#create-a-preliminary-template">Create a preliminary template</a></li>
<li><a class="reference internal" href="#extract-exemplary-events">Extract exemplary events</a></li>
<li><a class="reference internal" href="#create-the-final-template">Create the final template</a></li>
<li><a class="reference internal" href="#extract-all-events">Extract all events</a></li>
<li><a class="reference internal" href="#edit-detected-events">Edit detected events</a></li>
<li><a class="reference internal" href="#analyze-extracted-events">Analyze extracted events</a></li>
<li><a class="reference internal" href="#adjusting-event-detection-settings">Adjusting event detection settings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="latency_measurements.html"
                        title="previous chapter">Latency measurements</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="bibliography.html"
                        title="next chapter">Bibliography</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Christoph Schmidt-Hieber.
      Last updated on 05 August, 2021.
    </div>
  </body>
</html>